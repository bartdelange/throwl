name: Distribute app to Android & iOS stores ðŸš€
on:
  push:
    tags:
      - '*'
  workflow_dispatch:
    inputs:
      deploy:
        description: 'What to deploy'
        default: 'both'
        type: choice
        required: false
        options:
          - ios
          - android
          - both

jobs:
  install-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup directory and install required packages
        uses: ./.github/workflows/reusable-setup.yaml
        with:
          os: ubuntu-latest
          bundle: false

      - name: Run tests
        run: npm test

  deploy:
    name: Building and deploying to ${{ matrix.store }}
    needs: install-and-test
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            working_directory: android
            store: Google Play ðŸ¤–
          - os: ubuntu-latest
            working_directory: ios
            store: App Store ðŸ“±
    uses: ./.github/workflows/reusable-deploy.yaml
    if: ${{ github.event_name != 'workflow_dispatch' || inputs.deploy == 'both' || inputs.deploy == matrix.working_directory }}
    with:
      os: ${{ matrix.os }}
      working_directory: ${{ matrix.working_directory }}
      store: ${{ matrix.store }}
    secrets:
      # iOS
      APP_STORE_CONNECT_TEAM_ID: ${{ secrets.APP_STORE_CONNECT_TEAM_ID }}
      DEVELOPER_APP_ID: ${{ secrets.DEVELOPER_APP_ID }}
      DEVELOPER_APP_IDENTIFIER: ${{ secrets.DEVELOPER_APP_IDENTIFIER }}
      DEVELOPER_PORTAL_TEAM_ID: ${{ secrets.DEVELOPER_PORTAL_TEAM_ID }}
      FASTLANE_APPLE_ID: ${{ secrets.FASTLANE_APPLE_ID }}
      MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
      MATCH_GIT_BASIC_AUTHORIZATION: ${{ secrets.MATCH_GIT_BASIC_AUTHORIZATION }}
      APPLE_KEY_ID: ${{ secrets.APPLE_KEY_ID }}
      APPLE_ISSUER_ID: ${{ secrets.APPLE_ISSUER_ID }}
      APPLE_KEY_CONTENT: ${{ secrets.APPLE_KEY_CONTENT }}
      # Android
      ANDROID_KEYSTORE_FILE: ${{ secrets.ANDROID_KEYSTORE_FILE }}
      KEYSTORE_KEY_ALIAS: ${{ secrets.ANDROID_KEYSTORE_ALIAS }}
      KEYSTORE_KEY_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
      KEYSTORE_STORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
      PLAY_CONFIG_JSON: ${{ secrets.PLAY_CONFIG_JSON }}
