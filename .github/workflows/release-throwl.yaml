name: Distribute app to Android & iOS stores ðŸš€
on:
  push:
    tags:
      - '*'
  workflow_dispatch:
    inputs:
      deploy:
        description: 'What to deploy'
        default: 'both'
        type: choice
        required: false
        options: [ios, android, both]

jobs:
  install-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup directory and install required packages
        uses: ./.github/actions/reusable-setup/
        with:
          os: ubuntu-latest
          bundle: false

      - name: Run tests (Nx)
        run: yarn nx affected --target=test --base=origin/master --head=HEAD

  deploy_android:
    name: Continuous Deployment
    needs: install-and-test
    uses: ./.github/workflows/reusable-deploy.yaml
    if: ${{ github.event_name != 'workflow_dispatch' || inputs.deploy == 'both' || inputs.deploy == 'android' }}
    permissions:
      contents: read
    with:
      os: ubuntu-latest
      working_directory: apps/throwl/android
      store: Google Play Store
    secrets:
      ANDROID_KEYSTORE_FILE: ${{ secrets.ANDROID_KEYSTORE_FILE }}
      ANDROID_KEYSTORE_KEY_ALIAS: ${{ secrets.ANDROID_KEYSTORE_ALIAS }}
      ANDROID_KEYSTORE_KEY_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
      ANDROID_KEYSTORE_STORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
      ANDROID_PLAY_CONFIG_JSON: ${{ secrets.PLAY_CONFIG_JSON }}

  deploy_ios:
    name: Continuous Deployment
    needs: install-and-test
    uses: ./.github/workflows/reusable-deploy.yaml
    if: ${{ github.event_name != 'workflow_dispatch' || inputs.deploy == 'both' || inputs.deploy == 'ios' }}
    permissions:
      contents: read
    with:
      os: macos-latest
      working_directory: apps/throwl/ios
      store: TestFight
    secrets:
      IOS_APP_STORE_CONNECT_TEAM_ID: ${{ secrets.APP_STORE_CONNECT_TEAM_ID }}
      IOS_DEVELOPER_APP_ID: ${{ secrets.DEVELOPER_APP_ID }}
      IOS_DEVELOPER_APP_IDENTIFIER: ${{ secrets.DEVELOPER_APP_IDENTIFIER }}
      IOS_DEVELOPER_PORTAL_TEAM_ID: ${{ secrets.DEVELOPER_PORTAL_TEAM_ID }}
      IOS_FASTLANE_APPLE_ID: ${{ secrets.FASTLANE_APPLE_ID }}
      IOS_MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
      IOS_MATCH_GIT_BASIC_AUTHORIZATION: ${{ secrets.MATCH_GIT_BASIC_AUTHORIZATION }}
      IOS_APPLE_KEY_ID: ${{ secrets.APPLE_KEY_ID }}
      IOS_APPLE_ISSUER_ID: ${{ secrets.APPLE_ISSUER_ID }}
      IOS_APPLE_KEY_CONTENT: ${{ secrets.APPLE_KEY_CONTENT }}
