#!/usr/bin/env node

const { execFileSync, execSync } = require('node:child_process');
const { existsSync, writeFileSync } = require('node:fs');
const path = require('node:path');

function isYarnTempNode(p) {
  return typeof p === 'string' && /\/yarn--\d+-\d+(\.\d+)?\/node$/.test(p);
}

function runShellLogin(cmd) {
  const shell = process.env.SHELL || '/bin/zsh';
  return execFileSync(shell, ['-lc', cmd], { encoding: 'utf8' }).trim();
}

function tryResolveNodeFromNvmrc() {
  const nvmrcPath = path.resolve('.nvmrc');
  if (!existsSync(nvmrcPath)) return null;

  // Use a login shell so nvm is available the same way it is in your terminal
  // This forces nvm to select the .nvmrc version, then prints the resolved node path.
  const script = `
    set -e
    if [ -s "$HOME/.nvm/nvm.sh" ]; then . "$HOME/.nvm/nvm.sh"; fi
    if command -v nvm >/dev/null 2>&1; then
      nvm use --silent >/dev/null 2>&1 || nvm install >/dev/null 2>&1
      command -v node
    else
      exit 1
    fi
  `;
  try {
    return runShellLogin(script);
  } catch {
    return null;
  }
}

function main() {
  // 1) Best: if project uses .nvmrc, resolve node via nvm in a login shell.
  const nvmNode = tryResolveNodeFromNvmrc();
  if (nvmNode && !isYarnTempNode(nvmNode)) {
    return writeXcodeEnv(nvmNode);
  }

  // 2) Next best: ask your login shell for node (avoids Yarn’s temp PATH).
  let loginNode = null;
  try {
    loginNode = runShellLogin('command -v node');
  } catch {
    // ignore
  }
  if (loginNode && !isYarnTempNode(loginNode)) {
    return writeXcodeEnv(loginNode);
  }

  // 3) Fallback: node that is executing this script (but reject Yarn temp shim).
  const execPath = process.execPath;
  if (execPath && !isYarnTempNode(execPath)) {
    return writeXcodeEnv(execPath);
  }

  console.error('❌ Could not resolve a stable Node binary (got Yarn temp shim).');
  console.error(
    'Try running: `node scripts/write-xcode-env.js` (not via yarn), or ensure nvm is available in your login shell.',
  );
  process.exit(1);
}

function writeXcodeEnv(nodePath) {
  const xcodeEnvPath = path.join('ios', '.xcode.env');
  const contents = `# Auto-generated by npm script
# Do not edit manually
export NODE_BINARY="${nodePath}"
`;
  writeFileSync(xcodeEnvPath, contents, { encoding: 'utf8' });

  let version = '';
  try {
    version = execSync(`"${nodePath}" -v`, { encoding: 'utf8' }).trim();
  } catch {
    // ignore
  }

  console.log(`✅ Wrote ${xcodeEnvPath}`);
  console.log(`   NODE_BINARY=${nodePath}${version ? ` (${version})` : ''}`);
}

main();
